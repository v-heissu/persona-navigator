<!DOCTYPE html>
<html lang="it">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Personas Navigator</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
*,*::before,*::after{box-sizing:border-box;margin:0;padding:0}
:root{
  --bg:#0f0f13;--bg2:#16161d;--bg3:#1e1e28;--bg4:#282834;
  --text:#e4e4ef;--text2:#9d9db5;--text3:#6b6b82;
  --accent:#7c5cfc;--accent2:#9b7dff;--accent-glow:rgba(124,92,252,.15);
  --green:#34d399;--orange:#fb923c;--red:#f87171;--blue:#60a5fa;
  --radius:12px;--radius-sm:8px;
}
html{font-size:15px}
body{font-family:'Inter',-apple-system,BlinkMacSystemFont,'Segoe UI',sans-serif;background:var(--bg);color:var(--text);min-height:100vh;overflow:hidden}

/* Layout */
.app{display:flex;flex-direction:column;height:100vh}
header{display:flex;align-items:center;justify-content:space-between;padding:12px 24px;border-bottom:1px solid var(--bg3);background:var(--bg2);flex-shrink:0}
header h1{font-size:1.1rem;font-weight:700;display:flex;align-items:center;gap:8px}
.header-right{display:flex;align-items:center;gap:16px}
.header-status{font-size:.75rem;color:var(--text3);display:flex;align-items:center;gap:6px}
.status-dot{width:7px;height:7px;border-radius:50%;background:var(--text3)}
.status-dot.connected{background:var(--green);box-shadow:0 0 6px var(--green)}
.status-dot.loading{background:var(--orange);animation:pulse 1s infinite}
.header-actions button{padding:6px 14px;border-radius:var(--radius-sm);border:1px solid var(--bg4);background:var(--bg);color:var(--text2);font-size:.75rem;cursor:pointer;transition:all .2s}
.header-actions button:hover{border-color:var(--text3);color:var(--text)}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.4}}

/* Setup screen */
.setup-screen{display:flex;align-items:center;justify-content:center;flex:1;padding:24px}
.setup-card{background:var(--bg2);border:1px solid var(--bg3);border-radius:var(--radius);padding:40px;max-width:480px;width:100%}
.setup-card h2{font-size:1.4rem;margin-bottom:6px}
.setup-card p{color:var(--text2);margin-bottom:28px;line-height:1.5;font-size:.9rem}
.field{margin-bottom:18px}
.field label{display:block;font-size:.75rem;font-weight:600;color:var(--text2);text-transform:uppercase;letter-spacing:.5px;margin-bottom:6px}
.field select,.field input[type="text"],.field input[type="number"]{
  width:100%;padding:10px 14px;background:var(--bg);border:1px solid var(--bg4);border-radius:var(--radius-sm);
  color:var(--text);font-size:.9rem;outline:none;transition:border .2s;font-family:inherit}
.field select:focus,.field input:focus{border-color:var(--accent)}
.field select{cursor:pointer;appearance:none;background-image:url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='12' height='12' fill='%239d9db5' viewBox='0 0 16 16'%3E%3Cpath d='M8 11L3 6h10z'/%3E%3C/svg%3E");background-repeat:no-repeat;background-position:right 12px center}
.field-desc{font-size:.75rem;color:var(--text3);margin-top:4px}
.mode-toggle{display:flex;gap:8px;margin-bottom:18px}
.mode-btn{flex:1;padding:10px;border:1px solid var(--bg4);border-radius:var(--radius-sm);background:var(--bg);color:var(--text2);font-size:.85rem;font-weight:500;cursor:pointer;transition:all .2s;text-align:center;font-family:inherit}
.mode-btn.active{border-color:var(--accent);color:var(--text);background:var(--accent-glow)}
.autonomous-opts{display:none;background:var(--bg);border-radius:var(--radius-sm);padding:14px;margin-bottom:18px;border:1px solid var(--bg4)}
.autonomous-opts.visible{display:block}
.btn-primary{width:100%;padding:12px;background:var(--accent);border:none;border-radius:var(--radius-sm);color:#fff;font-size:.95rem;font-weight:600;cursor:pointer;transition:all .2s;font-family:inherit}
.btn-primary:hover{background:var(--accent2);transform:translateY(-1px)}
.btn-primary:disabled{opacity:.5;cursor:not-allowed;transform:none}

/* Session: two-column layout */
.session-screen{display:none;flex:1;overflow:hidden}
.session-screen.active{display:flex}
.session-layout{display:flex;width:100%;height:100%}

/* Left: Browser viewport */
.browser-panel{flex:1;display:flex;flex-direction:column;background:var(--bg);border-right:1px solid var(--bg3);min-width:0}
.browser-topbar{display:flex;align-items:center;gap:8px;padding:8px 16px;background:var(--bg2);border-bottom:1px solid var(--bg3);flex-shrink:0}
.browser-url{flex:1;font-size:.75rem;color:var(--text3);padding:6px 12px;background:var(--bg);border-radius:6px;border:1px solid var(--bg3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.browser-badge{font-size:.7rem;font-weight:600;color:var(--accent);padding:4px 10px;background:var(--accent-glow);border-radius:12px;white-space:nowrap}
.browser-viewport{flex:1;overflow:auto;display:flex;align-items:flex-start;justify-content:center;padding:0;background:#111}
.browser-viewport img{width:100%;display:block;max-height:100%;object-fit:contain}
.browser-viewport .empty-state{display:flex;align-items:center;justify-content:center;height:100%;color:var(--text3);font-size:.9rem}
.browser-footer{display:flex;align-items:center;gap:8px;padding:6px 16px;background:var(--bg2);border-top:1px solid var(--bg3);flex-shrink:0}
.step-text{font-size:.7rem;color:var(--text3)}
.step-bar{flex:1;height:3px;background:var(--bg4);border-radius:2px;overflow:hidden}
.step-bar-fill{height:100%;background:var(--accent);border-radius:2px;transition:width .5s ease;width:0}
.auto-controls{display:flex;gap:6px;margin-left:auto}
.auto-controls button{padding:5px 14px;border-radius:6px;border:1px solid var(--bg4);background:var(--bg);color:var(--text2);font-size:.75rem;cursor:pointer;transition:all .2s;font-family:inherit}
.auto-controls button:hover{border-color:var(--text3)}
.auto-controls .btn-stop{border-color:var(--red);color:var(--red)}

/* Right: Chat panel */
.chat-panel{width:400px;display:flex;flex-direction:column;background:var(--bg2);flex-shrink:0}
@media(max-width:900px){.chat-panel{width:100%;position:fixed;inset:0;z-index:50;display:none}.chat-panel.mobile-open{display:flex}}
.chat-header{padding:12px 20px;border-bottom:1px solid var(--bg3);display:flex;align-items:center;gap:10px;flex-shrink:0}
.chat-avatar{width:36px;height:36px;border-radius:50%;background:var(--accent);display:flex;align-items:center;justify-content:center;font-weight:700;color:#fff;font-size:1rem;flex-shrink:0}
.chat-persona-info{flex:1;min-width:0}
.chat-persona-name{font-weight:600;font-size:.9rem}
.chat-persona-desc{font-size:.7rem;color:var(--text3);white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
.chat-messages{flex:1;overflow-y:auto;padding:16px;display:flex;flex-direction:column;gap:12px}
.chat-messages::-webkit-scrollbar{width:4px}
.chat-messages::-webkit-scrollbar-thumb{background:var(--bg4);border-radius:2px}

/* Chat bubbles */
.msg{max-width:95%;animation:fadeIn .3s ease}
@keyframes fadeIn{from{opacity:0;transform:translateY(8px)}to{opacity:1;transform:none}}
.msg-persona{align-self:flex-start}
.msg-user{align-self:flex-end}
.msg-system{align-self:center}
.msg-bubble{padding:10px 14px;border-radius:14px;font-size:.85rem;line-height:1.55}
.msg-persona .msg-bubble{background:var(--bg3);border-bottom-left-radius:4px;color:var(--text)}
.msg-user .msg-bubble{background:var(--accent);border-bottom-right-radius:4px;color:#fff}
.msg-system .msg-bubble{background:transparent;border:1px solid var(--bg4);color:var(--text3);font-size:.75rem;padding:6px 12px;border-radius:20px}
.msg-name{font-size:.7rem;font-weight:600;color:var(--text3);margin-bottom:3px;padding-left:2px}
.msg-nav-info{display:flex;align-items:center;gap:6px;font-size:.7rem;color:var(--blue);margin-bottom:2px;padding-left:2px}

/* Chat input */
.chat-input-area{padding:12px 16px;border-top:1px solid var(--bg3);flex-shrink:0}
.chat-input-row{display:flex;gap:6px}
.chat-input-row input{flex:1;padding:10px 14px;background:var(--bg);border:1px solid var(--bg4);border-radius:20px;color:var(--text);font-size:.85rem;outline:none;transition:border .2s;font-family:inherit}
.chat-input-row input:focus{border-color:var(--accent)}
.chat-input-row button{width:38px;height:38px;border-radius:50%;background:var(--accent);border:none;color:#fff;font-size:1.1rem;cursor:pointer;transition:all .2s;display:flex;align-items:center;justify-content:center;flex-shrink:0}
.chat-input-row button:hover{background:var(--accent2)}
.chat-input-row button:disabled{opacity:.4;cursor:not-allowed}
.suggestions{display:flex;flex-wrap:wrap;gap:4px;margin-top:8px}
.suggestions button{padding:5px 12px;background:var(--bg);border:1px solid var(--bg4);border-radius:16px;color:var(--text2);font-size:.7rem;cursor:pointer;transition:all .2s;font-family:inherit}
.suggestions button:hover{border-color:var(--accent);color:var(--text)}

/* Loading overlay */
.loading-overlay{display:none;position:fixed;inset:0;background:rgba(15,15,19,.85);backdrop-filter:blur(4px);z-index:100;align-items:center;justify-content:center;flex-direction:column;gap:16px}
.loading-overlay.visible{display:flex}
.spinner{width:36px;height:36px;border:3px solid var(--bg4);border-top-color:var(--accent);border-radius:50%;animation:spin .8s linear infinite}
@keyframes spin{to{transform:rotate(360deg)}}
.loading-text{color:var(--text2);font-size:.85rem}

/* Toast */
.toast{position:fixed;bottom:20px;right:20px;padding:12px 18px;background:var(--bg3);border:1px solid var(--bg4);border-radius:var(--radius-sm);color:var(--text);font-size:.8rem;z-index:200;transform:translateY(100px);opacity:0;transition:all .3s}
.toast.visible{transform:translateY(0);opacity:1}
.toast.error{border-color:var(--red);color:var(--red)}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Personas Navigator</h1>
    <div class="header-right">
      <div class="header-actions" id="headerActions" style="display:none">
        <button onclick="exportSession()">Esporta</button>
        <button onclick="newSession()">Nuova sessione</button>
      </div>
      <div class="header-status">
        <div class="status-dot" id="statusDot"></div>
        <span id="statusText">Disconnesso</span>
      </div>
    </div>
  </header>

  <!-- Setup Screen -->
  <div class="setup-screen" id="setup">
    <div class="setup-card">
      <h2>Nuova sessione</h2>
      <p>Simula la navigazione di un sito web attraverso gli occhi di una persona reale.</p>
      <div class="field">
        <label>Persona</label>
        <select id="personaSelect"></select>
        <div class="field-desc" id="personaDesc"></div>
      </div>
      <div class="field">
        <label>URL del sito</label>
        <input type="text" id="urlInput" placeholder="https://esempio.com">
      </div>
      <div class="field">
        <label>Modalita</label>
        <div class="mode-toggle">
          <button class="mode-btn active" data-mode="guided" onclick="setMode('guided')">Guidata</button>
          <button class="mode-btn" data-mode="autonomous" onclick="setMode('autonomous')">Autonoma</button>
        </div>
      </div>
      <div class="autonomous-opts" id="autonomousOpts">
        <div class="field">
          <label>Obiettivo</label>
          <select id="objectiveSelect"></select>
        </div>
        <div class="field">
          <label>Max pagine</label>
          <input type="number" id="maxSteps" value="5" min="3" max="10">
        </div>
      </div>
      <button class="btn-primary" id="startBtn" onclick="startSession()">Avvia navigazione</button>
    </div>
  </div>

  <!-- Session Screen -->
  <div class="session-screen" id="session">
    <div class="session-layout">
      <!-- Left: Browser -->
      <div class="browser-panel">
        <div class="browser-topbar" id="browserTopbar" style="display:none">
          <div class="browser-url" id="urlBar"></div>
          <div class="browser-badge" id="pageBadge"></div>
        </div>
        <div class="browser-viewport" id="browserViewport">
          <div class="empty-state">In attesa di navigazione...</div>
        </div>
        <div class="browser-footer" id="browserFooter" style="display:none">
          <span class="step-text" id="stepText"></span>
          <div class="step-bar"><div class="step-bar-fill" id="stepBarFill"></div></div>
          <div class="auto-controls" id="autoControls" style="display:none">
            <button onclick="pauseAutonomous()" id="pauseBtn">Pausa</button>
            <button class="btn-stop" onclick="stopAutonomous()">Stop</button>
          </div>
        </div>
      </div>

      <!-- Right: Chat -->
      <div class="chat-panel">
        <div class="chat-header" id="chatHeader">
          <div class="chat-avatar" id="chatAvatar">?</div>
          <div class="chat-persona-info">
            <div class="chat-persona-name" id="chatPersonaName">Persona</div>
            <div class="chat-persona-desc" id="chatPersonaDesc"></div>
          </div>
        </div>
        <div class="chat-messages" id="chatMessages"></div>
        <div class="chat-input-area" id="chatInputArea">
          <div class="chat-input-row">
            <input type="text" id="chatInput" placeholder="Scrivi comando o domanda..."
                   onkeydown="if(event.key==='Enter')sendInput()">
            <button onclick="sendInput()" id="sendBtn">&#x27A4;</button>
          </div>
          <div class="suggestions" id="suggestionsArea"></div>
        </div>
      </div>
    </div>
  </div>
</div>

<div class="loading-overlay" id="loadingOverlay">
  <div class="spinner"></div>
  <div class="loading-text" id="loadingText">Caricamento...</div>
</div>
<div class="toast" id="toast"></div>

<script>
let ws = null;
let currentMode = 'guided';
let isAutonomousRunning = false;
let isPaused = false;
let personasList = [];
let objectivesList = [];
let selectedPersonaId = 'marco';

// === Init ===
document.addEventListener('DOMContentLoaded', async () => {
  const [pRes, oRes] = await Promise.all([
    fetch('/api/personas'), fetch('/api/objectives')
  ]);
  personasList = await pRes.json();
  objectivesList = await oRes.json();

  const sel = document.getElementById('personaSelect');
  personasList.forEach(p => {
    const opt = document.createElement('option');
    opt.value = p.id; opt.textContent = p.name;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', () => {
    const p = personasList.find(x => x.id === sel.value);
    document.getElementById('personaDesc').textContent = p ? p.description : '';
  });
  sel.dispatchEvent(new Event('change'));

  const oSel = document.getElementById('objectiveSelect');
  objectivesList.forEach(o => {
    const opt = document.createElement('option');
    opt.value = o.id; opt.textContent = o.label;
    oSel.appendChild(opt);
  });

  connectWebSocket();
});

// === WebSocket ===
function connectWebSocket() {
  const proto = location.protocol === 'https:' ? 'wss:' : 'ws:';
  ws = new WebSocket(`${proto}//${location.host}/ws`);
  ws.onopen = () => {
    document.getElementById('statusDot').className = 'status-dot connected';
    document.getElementById('statusText').textContent = 'Connesso';
  };
  ws.onclose = () => {
    document.getElementById('statusDot').className = 'status-dot';
    document.getElementById('statusText').textContent = 'Disconnesso';
    setTimeout(connectWebSocket, 3000);
  };
  ws.onmessage = (e) => handleEvent(JSON.parse(e.data));
}

function sendWS(msg) {
  if (ws && ws.readyState === WebSocket.OPEN) ws.send(JSON.stringify(msg));
}

// === Event Handler ===
function handleEvent(data) {
  const ev = data.event;

  if (ev === 'status') {
    document.getElementById('loadingText').textContent = data.message;
  }

  else if (ev === 'navigation') {
    hideLoading();
    showSession();
    updateBrowser(data);
    addChatNav(data.page_label, data.url);
    addChatMessage(data.persona_name, data.comment);
    updateSuggestions(data.suggestions || []);
    if (data.step && data.max_steps) updateProgress(data.step, data.max_steps);
  }

  else if (ev === 'autonomous_step') {
    hideLoading();
    updateBrowser(data);
    if (data.action && data.action !== 'DONE') {
      addChatAction(data.action, data.target, data.reasoning);
    }
    addChatMessage(data.persona_name, data.comment);
    updateSuggestions(data.suggestions || []);
    updateProgress(data.step, data.max_steps);
  }

  else if (ev === 'autonomous_done') {
    isAutonomousRunning = false;
    document.getElementById('autoControls').style.display = 'none';
    document.getElementById('chatInputArea').style.display = '';
    addChatSystem('Navigazione completata. Puoi fare domande alla persona.');
    showToast('Navigazione completata');
  }

  else if (ev === 'answer') {
    hideLoading();
    addChatUser(data.question);
    addChatMessage(data.persona_name, data.answer);
  }

  else if (ev === 'export') {
    downloadMarkdown(data.markdown);
  }

  else if (ev === 'error') {
    hideLoading();
    addChatSystem('Errore: ' + data.message);
    showToast(data.message, true);
  }
}

// === Setup ===
function setMode(mode) {
  currentMode = mode;
  document.querySelectorAll('.mode-btn').forEach(b =>
    b.classList.toggle('active', b.dataset.mode === mode));
  document.getElementById('autonomousOpts').classList.toggle('visible', mode === 'autonomous');
}

function startSession() {
  const url = document.getElementById('urlInput').value.trim();
  if (!url) { showToast('Inserisci un URL', true); return; }

  selectedPersonaId = document.getElementById('personaSelect').value;

  sendWS({
    action: 'start',
    persona_id: selectedPersonaId,
    url: url,
    mode: currentMode,
    max_steps: parseInt(document.getElementById('maxSteps').value) || 5,
    objective: document.getElementById('objectiveSelect').value
  });

  showLoading('Avvio browser...');

  if (currentMode === 'autonomous') {
    isAutonomousRunning = true;
  }
}

// === Session UI ===
function showSession() {
  document.getElementById('setup').style.display = 'none';
  document.getElementById('session').classList.add('active');
  document.getElementById('headerActions').style.display = '';

  // Set persona info in chat header
  const p = personasList.find(x => x.id === selectedPersonaId);
  if (p) {
    const name = p.name.split(' - ')[0];
    document.getElementById('chatAvatar').textContent = name.charAt(0);
    document.getElementById('chatPersonaName').textContent = name;
    document.getElementById('chatPersonaDesc').textContent = p.description || '';
  }

  if (isAutonomousRunning) {
    document.getElementById('autoControls').style.display = 'flex';
    document.getElementById('chatInputArea').style.display = 'none';
  }
}

function updateBrowser(data) {
  // Show topbar
  const topbar = document.getElementById('browserTopbar');
  topbar.style.display = '';
  document.getElementById('urlBar').textContent = data.url || '';
  document.getElementById('pageBadge').textContent = data.page_label || '';

  // Show screenshot
  const viewport = document.getElementById('browserViewport');
  viewport.innerHTML = `<img src="data:image/png;base64,${data.screenshot}" alt="Screenshot">`;

  // Show footer
  document.getElementById('browserFooter').style.display = '';
}

function updateProgress(step, max) {
  document.getElementById('stepText').textContent = `Pagina ${step}/${max}`;
  document.getElementById('stepBarFill').style.width = `${(step / max) * 100}%`;
}

function updateSuggestions(suggestions) {
  const area = document.getElementById('suggestionsArea');
  area.innerHTML = suggestions.map(s =>
    `<button onclick="sendSuggestion(this.textContent)">${esc(s)}</button>`
  ).join('');
}

// === Chat messages ===
function addChatMessage(name, text) {
  if (!text) return;
  const el = document.createElement('div');
  el.className = 'msg msg-persona';
  el.innerHTML = `<div class="msg-name">${esc(name || 'Persona')}</div><div class="msg-bubble">${esc(text)}</div>`;
  appendChat(el);
}

function addChatUser(text) {
  if (!text) return;
  const el = document.createElement('div');
  el.className = 'msg msg-user';
  el.innerHTML = `<div class="msg-bubble">${esc(text)}</div>`;
  appendChat(el);
}

function addChatSystem(text) {
  const el = document.createElement('div');
  el.className = 'msg msg-system';
  el.innerHTML = `<div class="msg-bubble">${esc(text)}</div>`;
  appendChat(el);
}

function addChatNav(pageLabel, url) {
  const el = document.createElement('div');
  el.className = 'msg msg-system';
  const shortUrl = url ? (url.length > 50 ? url.substring(0, 50) + '...' : url) : '';
  el.innerHTML = `<div class="msg-bubble">Navigazione: ${esc(pageLabel || 'Pagina')} - ${esc(shortUrl)}</div>`;
  appendChat(el);
}

function addChatAction(action, target, reasoning) {
  let label = action;
  if (action === 'CLICK' && target) label = `Click: "${target}"`;
  else if (action === 'SCROLL_DOWN') label = 'Scroll giu\'';
  else if (action === 'BACK') label = 'Torna indietro';

  const el = document.createElement('div');
  el.className = 'msg msg-system';
  el.innerHTML = `<div class="msg-bubble">${esc(label)}${reasoning ? ' - ' + esc(reasoning) : ''}</div>`;
  appendChat(el);
}

function appendChat(el) {
  const container = document.getElementById('chatMessages');
  container.appendChild(el);
  container.scrollTop = container.scrollHeight;
}

// === Input ===
function sendInput() {
  const input = document.getElementById('chatInput');
  const text = input.value.trim();
  if (!text) return;
  input.value = '';
  addChatUser(text);
  showLoading('Analizzo...');
  sendWS({ action: 'input', text });
}

function sendSuggestion(text) {
  addChatUser(text);
  showLoading('Analizzo...');
  sendWS({ action: 'input', text });
}

// === Autonomous ===
function pauseAutonomous() {
  if (isPaused) {
    isPaused = false;
    sendWS({ action: 'resume_autonomous' });
    document.getElementById('pauseBtn').textContent = 'Pausa';
    document.getElementById('chatInputArea').style.display = 'none';
  } else {
    isPaused = true;
    sendWS({ action: 'pause_autonomous' });
    document.getElementById('pauseBtn').textContent = 'Riprendi';
    document.getElementById('chatInputArea').style.display = '';
    addChatSystem('In pausa. Puoi fare domande.');
  }
}

function stopAutonomous() {
  isAutonomousRunning = false;
  sendWS({ action: 'stop_autonomous' });
}

// === Export / New ===
function exportSession() {
  sendWS({ action: 'export', mode: currentMode, objective: document.getElementById('objectiveSelect').value });
}

function downloadMarkdown(md) {
  const blob = new Blob([md], { type: 'text/markdown' });
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  a.download = `sessione_${new Date().toISOString().slice(0, 16).replace(/[:-]/g, '')}.md`;
  a.click();
  URL.revokeObjectURL(a.href);
  showToast('Export scaricato');
}

function newSession() {
  location.reload();
}

// === Utils ===
function showLoading(text) {
  document.getElementById('loadingText').textContent = text || 'Caricamento...';
  document.getElementById('loadingOverlay').classList.add('visible');
}
function hideLoading() {
  document.getElementById('loadingOverlay').classList.remove('visible');
}
function showToast(msg, isError) {
  const t = document.getElementById('toast');
  t.textContent = msg;
  t.className = 'toast visible' + (isError ? ' error' : '');
  setTimeout(() => t.className = 'toast', 3000);
}
function esc(s) {
  if (!s) return '';
  return s.replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
}
</script>
</body>
</html>
